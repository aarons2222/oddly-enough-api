const html = "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>Oddly Enough ‚Äî Mission Control</title>\n<link rel=\"preconnect\" href=\"https://fonts.googleapis.com\">\n<link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin>\n<link href=\"https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap\" rel=\"stylesheet\">\n<style>\n*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}\n:root{\n  --bg:#0a0e1a;--bg2:#0f1424;--bg3:#141929;\n  --glass:rgba(20,25,45,0.65);--glass-border:rgba(255,255,255,0.06);\n  --teal:#14B8A6;--teal-dim:rgba(20,184,166,0.15);--teal-glow:rgba(20,184,166,0.3);\n  --coral:#FF6B6B;--coral-dim:rgba(255,107,107,0.15);\n  --purple:#A78BFA;--purple-dim:rgba(167,139,250,0.15);\n  --green:#34D399;--green-dim:rgba(52,211,153,0.15);\n  --yellow:#FBBF24;--yellow-dim:rgba(251,191,36,0.15);\n  --blue:#60A5FA;--blue-dim:rgba(96,165,250,0.15);\n  --text:#E2E8F0;--text-dim:#64748B;--text-muted:#475569;\n  --radius:12px;--radius-sm:8px;\n}\nhtml{font-size:15px;scroll-behavior:smooth}\nbody{\n  font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);\n  min-height:100vh;overflow-x:hidden;\n  background-image:\n    radial-gradient(ellipse 80% 50% at 50% -20%,rgba(20,184,166,0.08),transparent),\n    radial-gradient(ellipse 60% 40% at 80% 100%,rgba(255,107,107,0.05),transparent);\n}\nh1,h2,h3,h4{font-family:'Space Grotesk',sans-serif;font-weight:600}\n\n/* Scrollbar */\n::-webkit-scrollbar{width:6px;height:6px}\n::-webkit-scrollbar-track{background:transparent}\n::-webkit-scrollbar-thumb{background:var(--text-muted);border-radius:3px}\n\n/* Layout */\n.container{max-width:1440px;margin:0 auto;padding:0 24px 60px}\n\n/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */\n.header{\n  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;\n  padding:28px 0 20px;border-bottom:1px solid var(--glass-border);margin-bottom:28px;\n}\n.header-left{display:flex;align-items:center;gap:14px}\n.logo-mark{\n  width:42px;height:42px;border-radius:10px;\n  background:linear-gradient(135deg,var(--teal),var(--coral));\n  display:flex;align-items:center;justify-content:center;font-size:20px;\n  box-shadow:0 0 24px var(--teal-glow);\n}\n.header h1{font-size:1.55rem;letter-spacing:-0.5px}\n.header h1 span{color:var(--teal)}\n.header-right{display:flex;align-items:center;gap:16px;flex-wrap:wrap}\n.live-dot{\n  width:8px;height:8px;border-radius:50%;background:var(--teal);\n  animation:pulse-dot 2s infinite;display:inline-block;\n}\n@keyframes pulse-dot{0%,100%{box-shadow:0 0 0 0 var(--teal-glow)}50%{box-shadow:0 0 0 6px transparent}}\n.refresh-info{font-size:.78rem;color:var(--text-dim)}\n.header-stats{display:flex;gap:20px;flex-wrap:wrap}\n.header-stat{text-align:center}\n.header-stat .val{font-family:'Space Grotesk',sans-serif;font-size:1.3rem;font-weight:700;color:var(--teal)}\n.header-stat .lbl{font-size:.65rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim)}\n\n/* ‚îÄ‚îÄ Glass Card ‚îÄ‚îÄ */\n.card{\n  background:var(--glass);border:1px solid var(--glass-border);border-radius:var(--radius);\n  padding:22px;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);\n  transition:border-color .2s;\n}\n.card:hover{border-color:rgba(255,255,255,0.1)}\n.card-title{\n  font-family:'Space Grotesk',sans-serif;font-size:.85rem;font-weight:600;\n  text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:16px;\n  display:flex;align-items:center;gap:8px;\n}\n.card-title .icon{font-size:1rem}\n\n/* ‚îÄ‚îÄ Pipeline Flow ‚îÄ‚îÄ */\n.pipeline-section{margin-bottom:28px}\n.pipeline-flow{\n  display:flex;align-items:center;justify-content:center;gap:0;flex-wrap:wrap;\n  padding:20px 0;\n}\n.pipeline-node{\n  text-align:center;padding:18px 28px;border-radius:var(--radius);\n  min-width:130px;position:relative;transition:transform .2s;\n}\n.pipeline-node:hover{transform:translateY(-2px)}\n.pipeline-node .count{font-family:'Space Grotesk',sans-serif;font-size:2.2rem;font-weight:700;line-height:1}\n.pipeline-node .label{font-size:.72rem;text-transform:uppercase;letter-spacing:.8px;margin-top:6px;opacity:.8}\n.pn-found{background:var(--yellow-dim);color:var(--yellow)}\n.pn-summarising{background:var(--blue-dim);color:var(--blue)}\n.pn-ready{background:var(--green-dim);color:var(--green)}\n.pn-published{background:var(--teal-dim);color:var(--teal)}\n.pn-rejected{background:var(--coral-dim);color:var(--coral)}\n.pipeline-arrow{\n  font-size:1.4rem;color:var(--text-muted);padding:0 8px;flex-shrink:0;\n}\n.pipeline-arrow::after{content:'‚Ä∫';font-family:'Space Grotesk',sans-serif;font-weight:300;font-size:2rem}\n.pipeline-rejected-sep{\n  width:1px;height:50px;background:var(--glass-border);margin:0 18px;flex-shrink:0;\n}\n\n/* ‚îÄ‚îÄ Agent Cards ‚îÄ‚îÄ */\n.agents-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-bottom:28px}\n.agent-card{position:relative;overflow:hidden}\n.agent-card::before{\n  content:'';position:absolute;top:0;left:0;right:0;height:3px;\n  border-radius:var(--radius) var(--radius) 0 0;\n}\n.agent-scout::before{background:var(--teal)}\n.agent-quill::before{background:var(--purple)}\n.agent-editor::before{background:var(--green)}\n.agent-promoter::before{background:var(--coral)}\n.agent-emoji{font-size:1.6rem;margin-bottom:8px;display:block}\n.agent-name{font-family:'Space Grotesk',sans-serif;font-size:1.05rem;font-weight:600;margin-bottom:12px}\n.agent-metric{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--glass-border)}\n.agent-metric:last-child{border-bottom:none}\n.agent-metric .lbl{font-size:.78rem;color:var(--text-dim)}\n.agent-metric .val{font-family:'Space Grotesk',sans-serif;font-weight:600;font-size:.92rem}\n\n/* ‚îÄ‚îÄ Stats Bar ‚îÄ‚îÄ */\n.stats-bar{\n  display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:28px;\n}\n.stat-card{text-align:center;padding:18px 14px}\n.stat-card .val{font-family:'Space Grotesk',sans-serif;font-size:1.8rem;font-weight:700;color:var(--teal)}\n.stat-card .lbl{font-size:.68rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-top:4px}\n\n/* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */\n.table-wrap{overflow-x:auto;margin-bottom:28px}\ntable{width:100%;border-collapse:collapse;font-size:.82rem}\nthead th{\n  font-family:'Space Grotesk',sans-serif;font-size:.7rem;text-transform:uppercase;\n  letter-spacing:.8px;color:var(--text-dim);text-align:left;padding:10px 12px;\n  border-bottom:1px solid var(--glass-border);font-weight:600;\n}\ntbody tr{border-bottom:1px solid rgba(255,255,255,0.03);transition:background .15s}\ntbody tr:hover{background:rgba(255,255,255,0.02)}\ntbody td{padding:10px 12px;vertical-align:middle}\n.badge{\n  display:inline-block;padding:3px 10px;border-radius:20px;font-size:.7rem;\n  font-weight:600;font-family:'Space Grotesk',sans-serif;\n}\n.badge-found{background:var(--yellow-dim);color:var(--yellow)}\n.badge-summarising{background:var(--blue-dim);color:var(--blue)}\n.badge-ready{background:var(--green-dim);color:var(--green)}\n.badge-published{background:var(--teal-dim);color:var(--teal)}\n.badge-rejected{background:var(--coral-dim);color:var(--coral)}\n.weirdness-badge{\n  display:inline-flex;align-items:center;justify-content:center;\n  width:32px;height:32px;border-radius:50%;font-size:.78rem;font-weight:700;\n  font-family:'Space Grotesk',sans-serif;\n}\n.w-low{background:var(--blue-dim);color:var(--blue)}\n.w-mid{background:var(--yellow-dim);color:var(--yellow)}\n.w-high{background:var(--coral-dim);color:var(--coral)}\n.source-link{color:var(--teal);text-decoration:none;font-size:.75rem;opacity:.7;transition:opacity .15s}\n.source-link:hover{opacity:1;text-decoration:underline}\n.title-cell{max-width:320px}\n.title-text{font-weight:500;line-height:1.3}\n.category-tag{font-size:.65rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}\n.time-ago{color:var(--text-dim);font-size:.75rem;white-space:nowrap}\n\n/* ‚îÄ‚îÄ Activity Log ‚îÄ‚îÄ */\n.log-section{margin-bottom:28px}\n.log-feed{max-height:420px;overflow-y:auto;display:flex;flex-direction:column;gap:6px}\n.log-entry{\n  display:flex;align-items:flex-start;gap:12px;padding:10px 14px;\n  border-radius:var(--radius-sm);background:rgba(255,255,255,0.015);\n  border-left:3px solid transparent;font-size:.8rem;transition:background .15s;\n}\n.log-entry:hover{background:rgba(255,255,255,0.03)}\n.log-scout{border-left-color:var(--teal)}\n.log-quill{border-left-color:var(--purple)}\n.log-editor{border-left-color:var(--green)}\n.log-promoter{border-left-color:var(--coral)}\n.log-time{color:var(--text-muted);font-size:.7rem;white-space:nowrap;min-width:60px;padding-top:2px}\n.log-agent{\n  font-family:'Space Grotesk',sans-serif;font-weight:600;font-size:.72rem;\n  text-transform:uppercase;letter-spacing:.5px;min-width:64px;padding-top:1px;\n}\n.log-agent.a-scout{color:var(--teal)}\n.log-agent.a-quill{color:var(--purple)}\n.log-agent.a-editor{color:var(--green)}\n.log-agent.a-promoter{color:var(--coral)}\n.log-action{color:var(--text);flex:1;line-height:1.4}\n.log-action strong{font-weight:600}\n\n/* ‚îÄ‚îÄ Two-col layout ‚îÄ‚îÄ */\n.two-col{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px}\n@media(max-width:900px){.two-col{grid-template-columns:1fr}}\n\n/* ‚îÄ‚îÄ Loading / Error ‚îÄ‚îÄ */\n.loading{text-align:center;padding:40px;color:var(--text-dim)}\n.loading-spinner{\n  width:28px;height:28px;border:3px solid var(--glass-border);\n  border-top-color:var(--teal);border-radius:50%;animation:spin .8s linear infinite;\n  margin:0 auto 12px;\n}\n@keyframes spin{to{transform:rotate(360deg)}}\n.error-msg{color:var(--coral);font-size:.82rem;padding:12px;text-align:center}\n.empty-msg{color:var(--text-muted);font-size:.82rem;padding:20px;text-align:center;font-style:italic}\n\n/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */\n@media(max-width:768px){\n  .header{flex-direction:column;align-items:flex-start}\n  .pipeline-flow{flex-direction:column;gap:8px}\n  .pipeline-arrow{transform:rotate(90deg)}\n  .pipeline-rejected-sep{width:50px;height:1px;margin:8px 0}\n  .container{padding:0 14px 40px}\n}\n\n/* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */\n@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}\n.fade-in{animation:fadeIn .4s ease-out both}\n.fade-in-1{animation-delay:.05s}.fade-in-2{animation-delay:.1s}\n.fade-in-3{animation-delay:.15s}.fade-in-4{animation-delay:.2s}\n.fade-in-5{animation-delay:.25s}.fade-in-6{animation-delay:.3s}\n</style>\n</head>\n<body>\n<div class=\"container\">\n\n  <!-- Header -->\n  <header class=\"header fade-in\">\n    <div class=\"header-left\">\n      <div class=\"logo-mark\">‚ö°</div>\n      <div>\n        <h1>Oddly Enough ‚Äî <span>Mission Control</span></h1>\n        <div style=\"display:flex;align-items:center;gap:8px;margin-top:4px\">\n          <span class=\"live-dot\"></span>\n          <span class=\"refresh-info\">Live ¬∑ refreshes every 30s ¬∑ <span id=\"last-refresh\">‚Äî</span></span>\n        </div>\n      </div>\n    </div>\n    <div class=\"header-right\">\n      <div class=\"header-stats\" id=\"header-stats\">\n        <div class=\"header-stat\"><div class=\"val\" id=\"hs-today\">‚Äî</div><div class=\"lbl\">Today</div></div>\n        <div class=\"header-stat\"><div class=\"val\" id=\"hs-pending\">‚Äî</div><div class=\"lbl\">In Pipeline</div></div>\n        <div class=\"header-stat\"><div class=\"val\" id=\"hs-published\">‚Äî</div><div class=\"lbl\">Published</div></div>\n      </div>\n    </div>\n  </header>\n\n  <!-- Stats Bar -->\n  <section class=\"stats-bar fade-in fade-in-1\" id=\"stats-bar\">\n    <div class=\"card stat-card\"><div class=\"val\" id=\"st-total\">‚Äî</div><div class=\"lbl\">Total Published</div></div>\n    <div class=\"card stat-card\"><div class=\"val\" id=\"st-today\">‚Äî</div><div class=\"lbl\">Articles Today</div></div>\n    <div class=\"card stat-card\"><div class=\"val\" id=\"st-weird\">‚Äî</div><div class=\"lbl\">Avg Weirdness</div></div>\n    <div class=\"card stat-card\"><div class=\"val\" id=\"st-reject\">‚Äî</div><div class=\"lbl\">Rejection Rate</div></div>\n    <div class=\"card stat-card\"><div class=\"val\" id=\"st-throughput\">‚Äî</div><div class=\"lbl\">Articles / Day</div></div>\n  </section>\n\n  <!-- Pipeline Overview -->\n  <section class=\"pipeline-section card fade-in fade-in-2\">\n    <div class=\"card-title\"><span class=\"icon\">üîÑ</span> Pipeline Overview</div>\n    <div class=\"pipeline-flow\" id=\"pipeline-flow\">\n      <div class=\"pipeline-node pn-found\"><div class=\"count\" id=\"pf-found\">‚Äî</div><div class=\"label\">Found</div></div>\n      <div class=\"pipeline-arrow\"></div>\n      <div class=\"pipeline-node pn-summarising\"><div class=\"count\" id=\"pf-summarising\">‚Äî</div><div class=\"label\">Summarising</div></div>\n      <div class=\"pipeline-arrow\"></div>\n      <div class=\"pipeline-node pn-ready\"><div class=\"count\" id=\"pf-ready\">‚Äî</div><div class=\"label\">Ready</div></div>\n      <div class=\"pipeline-arrow\"></div>\n      <div class=\"pipeline-node pn-published\"><div class=\"count\" id=\"pf-published\">‚Äî</div><div class=\"label\">Published</div></div>\n      <div class=\"pipeline-rejected-sep\"></div>\n      <div class=\"pipeline-node pn-rejected\"><div class=\"count\" id=\"pf-rejected\">‚Äî</div><div class=\"label\">Rejected</div></div>\n    </div>\n  </section>\n\n  <!-- Agent Status Cards -->\n  <section class=\"agents-grid fade-in fade-in-3\">\n    <div class=\"card agent-card agent-scout\" id=\"agent-scout\">\n      <span class=\"agent-emoji\">üîç</span>\n      <div class=\"agent-name\">Scout</div>\n      <div class=\"agent-metric\"><span class=\"lbl\">Last Activity</span><span class=\"val\" id=\"as-scout-time\">‚Äî</span></div>\n      <div class=\"agent-metric\"><span class=\"lbl\">Found Today</span><span class=\"val\" id=\"as-scout-count\">‚Äî</span></div>\n    </div>\n    <div class=\"card agent-card agent-quill\" id=\"agent-quill\">\n      <span class=\"agent-emoji\">‚úçÔ∏è</span>\n      <div class=\"agent-name\">Quill</div>\n      <div class=\"agent-metric\"><span class=\"lbl\">Last Activity</span><span class=\"val\" id=\"as-quill-time\">‚Äî</span></div>\n      <div class=\"agent-metric\"><span class=\"lbl\">Summarised Today</span><span class=\"val\" id=\"as-quill-count\">‚Äî</span></div>\n    </div>\n    <div class=\"card agent-card agent-editor\" id=\"agent-editor\">\n      <span class=\"agent-emoji\">üõ°Ô∏è</span>\n      <div class=\"agent-name\">Editor</div>\n      <div class=\"agent-metric\"><span class=\"lbl\">Last Activity</span><span class=\"val\" id=\"as-editor-time\">‚Äî</span></div>\n      <div class=\"agent-metric\"><span class=\"lbl\">Published / Rejected</span><span class=\"val\" id=\"as-editor-count\">‚Äî</span></div>\n    </div>\n    <div class=\"card agent-card agent-promoter\" id=\"agent-promoter\">\n      <span class=\"agent-emoji\">üì£</span>\n      <div class=\"agent-name\">Promoter</div>\n      <div class=\"agent-metric\"><span class=\"lbl\">Last Activity</span><span class=\"val\" id=\"as-promoter-time\">‚Äî</span></div>\n      <div class=\"agent-metric\"><span class=\"lbl\">Posts Drafted</span><span class=\"val\" id=\"as-promoter-count\">‚Äî</span></div>\n    </div>\n  </section>\n\n  <!-- Two Column: Articles + Drafts -->\n  <div class=\"two-col fade-in fade-in-4\">\n    <!-- Recent Articles -->\n    <section class=\"card\">\n      <div class=\"card-title\"><span class=\"icon\">üì∞</span> Recent Articles</div>\n      <div class=\"table-wrap\" id=\"articles-table\">\n        <div class=\"loading\"><div class=\"loading-spinner\"></div>Loading articles‚Ä¶</div>\n      </div>\n    </section>\n\n    <!-- Draft Pipeline -->\n    <section class=\"card\">\n      <div class=\"card-title\"><span class=\"icon\">üß™</span> Draft Pipeline</div>\n      <div class=\"table-wrap\" id=\"drafts-table\">\n        <div class=\"loading\"><div class=\"loading-spinner\"></div>Loading drafts‚Ä¶</div>\n      </div>\n    </section>\n  </div>\n\n  <!-- Activity Log -->\n  <section class=\"card log-section fade-in fade-in-5\">\n    <div class=\"card-title\"><span class=\"icon\">üìã</span> Agent Activity Log</div>\n    <div class=\"log-feed\" id=\"log-feed\">\n      <div class=\"loading\"><div class=\"loading-spinner\"></div>Loading activity‚Ä¶</div>\n    </div>\n  </section>\n\n</div>\n\n<script>\n// ‚îÄ‚îÄ Config ‚îÄ‚îÄ\nconst SUPABASE_URL = 'https://wzvvfsuumtmewrogiqed.supabase.co';\nconst SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6dnZmc3V1bXRtZXdyb2dpcWVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0Njg2NTksImV4cCI6MjA4NjA0NDY1OX0.sGFlr7LsVwK_olfGMunc5z0LncRDCyUOaHAcJpmb2q8';\nconst REFRESH_MS = 30000;\n\nconst headers = {\n  'apikey': SUPABASE_KEY,\n  'Authorization': `Bearer ${SUPABASE_KEY}`,\n  'Content-Type': 'application/json',\n};\nconst countHeaders = { ...headers, 'Prefer': 'count=exact' };\n\nfunction api(path, opts = {}) {\n  const h = opts.count ? countHeaders : headers;\n  return fetch(`${SUPABASE_URL}${path}`, { headers: h })\n    .then(async r => {\n      const data = await r.json().catch(() => []);\n      const count = opts.count ? parseInt(r.headers.get('content-range')?.split('/')[1] || '0', 10) : null;\n      return { data, count };\n    })\n    .catch(err => ({ data: [], count: 0, error: err.message }));\n}\n\n// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ\nfunction timeAgo(dateStr) {\n  if (!dateStr) return '‚Äî';\n  const now = Date.now();\n  const then = new Date(dateStr).getTime();\n  const diff = Math.max(0, now - then);\n  const mins = Math.floor(diff / 60000);\n  if (mins < 1) return 'just now';\n  if (mins < 60) return `${mins}m ago`;\n  const hrs = Math.floor(mins / 60);\n  if (hrs < 24) return `${hrs}h ${mins % 60}m ago`;\n  const days = Math.floor(hrs / 24);\n  return `${days}d ago`;\n}\n\nfunction shortTime(dateStr) {\n  if (!dateStr) return '‚Äî';\n  const d = new Date(dateStr);\n  return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });\n}\n\nfunction todayStart() {\n  const d = new Date();\n  d.setHours(0, 0, 0, 0);\n  return d.toISOString();\n}\n\nfunction weirdnessClass(score) {\n  if (score == null) return 'w-low';\n  if (score >= 8) return 'w-high';\n  if (score >= 5) return 'w-mid';\n  return 'w-low';\n}\n\nfunction escHtml(s) {\n  if (!s) return '';\n  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;');\n}\n\nfunction truncate(s, n) {\n  if (!s) return '';\n  return s.length > n ? s.slice(0, n) + '‚Ä¶' : s;\n}\n\n// ‚îÄ‚îÄ Render Functions ‚îÄ‚îÄ\nfunction renderArticlesTable(articles) {\n  const el = document.getElementById('articles-table');\n  if (!articles || articles.length === 0) {\n    el.innerHTML = '<div class=\"empty-msg\">No published articles yet</div>';\n    return;\n  }\n  let html = `<table><thead><tr>\n    <th>Title</th><th>Category</th><th style=\"text-align:center\">Weird</th><th>Published</th><th>Source</th>\n  </tr></thead><tbody>`;\n  for (const a of articles) {\n    const wc = weirdnessClass(a.weirdness_score);\n    html += `<tr>\n      <td class=\"title-cell\"><div class=\"title-text\">${escHtml(truncate(a.title, 70))}</div></td>\n      <td><span class=\"category-tag\">${escHtml(a.category || '‚Äî')}</span></td>\n      <td style=\"text-align:center\"><span class=\"weirdness-badge ${wc}\">${a.weirdness_score ?? '?'}</span></td>\n      <td><span class=\"time-ago\">${timeAgo(a.published_at)}</span></td>\n      <td>${a.source_url ? `<a href=\"${escHtml(a.source_url)}\" target=\"_blank\" rel=\"noopener\" class=\"source-link\">‚Üó source</a>` : '‚Äî'}</td>\n    </tr>`;\n  }\n  html += '</tbody></table>';\n  el.innerHTML = html;\n}\n\nfunction renderDraftsTable(drafts) {\n  const el = document.getElementById('drafts-table');\n  if (!drafts || drafts.length === 0) {\n    el.innerHTML = '<div class=\"empty-msg\">No drafts in pipeline</div>';\n    return;\n  }\n  let html = `<table><thead><tr>\n    <th>Title</th><th>Status</th><th style=\"text-align:center\">Weird</th><th>In Pipeline</th>\n  </tr></thead><tbody>`;\n  for (const d of drafts) {\n    const wc = weirdnessClass(d.weirdness_score);\n    const statusClass = `badge-${d.status || 'found'}`;\n    html += `<tr>\n      <td class=\"title-cell\"><div class=\"title-text\">${escHtml(truncate(d.title, 60))}</div></td>\n      <td><span class=\"badge ${statusClass}\">${escHtml(d.status || 'unknown')}</span></td>\n      <td style=\"text-align:center\"><span class=\"weirdness-badge ${wc}\">${d.weirdness_score ?? '?'}</span></td>\n      <td><span class=\"time-ago\">${timeAgo(d.created_at)}</span></td>\n    </tr>`;\n  }\n  html += '</tbody></table>';\n  el.innerHTML = html;\n}\n\nfunction renderLogFeed(logs) {\n  const el = document.getElementById('log-feed');\n  if (!logs || logs.length === 0) {\n    el.innerHTML = '<div class=\"empty-msg\">No agent activity yet</div>';\n    return;\n  }\n  let html = '';\n  for (const l of logs) {\n    const agent = (l.agent || 'unknown').toLowerCase();\n    const agentClass = ['scout','quill','editor','promoter'].includes(agent) ? agent : 'scout';\n    const details = l.details ? (typeof l.details === 'string' ? l.details : JSON.stringify(l.details)) : '';\n    const detailStr = details ? ` ‚Äî <span style=\"color:var(--text-dim)\">${escHtml(truncate(details, 120))}</span>` : '';\n    html += `<div class=\"log-entry log-${agentClass}\">\n      <span class=\"log-time\">${shortTime(l.created_at)}</span>\n      <span class=\"log-agent a-${agentClass}\">${escHtml(agent)}</span>\n      <span class=\"log-action\"><strong>${escHtml(l.action || '‚Äî')}</strong>${detailStr}</span>\n    </div>`;\n  }\n  el.innerHTML = html;\n}\n\nfunction renderPipeline(drafts) {\n  const counts = { found: 0, summarising: 0, ready: 0, published: 0, rejected: 0 };\n  if (drafts) {\n    for (const d of drafts) {\n      const s = d.status || 'found';\n      if (counts[s] !== undefined) counts[s]++;\n    }\n  }\n  document.getElementById('pf-found').textContent = counts.found;\n  document.getElementById('pf-summarising').textContent = counts.summarising;\n  document.getElementById('pf-ready').textContent = counts.ready;\n  document.getElementById('pf-published').textContent = counts.published;\n  document.getElementById('pf-rejected').textContent = counts.rejected;\n\n  // Header pending = found + summarising + ready\n  document.getElementById('hs-pending').textContent = counts.found + counts.summarising + counts.ready;\n}\n\nfunction renderAgents(logs) {\n  const agents = {\n    scout: { time: null, count: 0 },\n    quill: { time: null, count: 0 },\n    editor: { time: null, countPub: 0, countRej: 0 },\n    promoter: { time: null, count: 0 },\n  };\n  const todayISO = todayStart();\n  if (logs) {\n    for (const l of logs) {\n      const a = (l.agent || '').toLowerCase();\n      const isToday = l.created_at && l.created_at >= todayISO;\n      if (a === 'scout') {\n        if (!agents.scout.time) agents.scout.time = l.created_at;\n        if (isToday) agents.scout.count++;\n      } else if (a === 'quill') {\n        if (!agents.quill.time) agents.quill.time = l.created_at;\n        if (isToday) agents.quill.count++;\n      } else if (a === 'editor') {\n        if (!agents.editor.time) agents.editor.time = l.created_at;\n        if (isToday) {\n          const act = (l.action || '').toLowerCase();\n          if (act.includes('publish')) agents.editor.countPub++;\n          else if (act.includes('reject')) agents.editor.countRej++;\n          else agents.editor.countPub++;\n        }\n      } else if (a === 'promoter') {\n        if (!agents.promoter.time) agents.promoter.time = l.created_at;\n        if (isToday) agents.promoter.count++;\n      }\n    }\n  }\n  document.getElementById('as-scout-time').textContent = timeAgo(agents.scout.time);\n  document.getElementById('as-scout-count').textContent = agents.scout.count;\n  document.getElementById('as-quill-time').textContent = timeAgo(agents.quill.time);\n  document.getElementById('as-quill-count').textContent = agents.quill.count;\n  document.getElementById('as-editor-time').textContent = timeAgo(agents.editor.time);\n  document.getElementById('as-editor-count').textContent = `${agents.editor.countPub} / ${agents.editor.countRej}`;\n  document.getElementById('as-promoter-time').textContent = timeAgo(agents.promoter.time);\n  document.getElementById('as-promoter-count').textContent = agents.promoter.count;\n}\n\nasync function renderStats(articles, allDrafts) {\n  // Total published (count from articles table)\n  const { count: totalPublished } = await api('/rest/v1/articles?select=id', { count: true });\n  document.getElementById('st-total').textContent = totalPublished ?? '‚Äî';\n\n  // Today's articles\n  const todayISO = todayStart();\n  const { count: todayCount } = await api(`/rest/v1/articles?select=id&published_at=gte.${todayISO}`, { count: true });\n  document.getElementById('st-today').textContent = todayCount ?? 0;\n  document.getElementById('hs-today').textContent = todayCount ?? 0;\n  document.getElementById('hs-published').textContent = totalPublished ?? '‚Äî';\n\n  // Average weirdness\n  if (articles && articles.length > 0) {\n    const scores = articles.filter(a => a.weirdness_score != null).map(a => a.weirdness_score);\n    const avg = scores.length ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : '‚Äî';\n    document.getElementById('st-weird').textContent = avg;\n  }\n\n  // Rejection rate\n  if (allDrafts && allDrafts.length > 0) {\n    const rejected = allDrafts.filter(d => d.status === 'rejected').length;\n    const total = allDrafts.length;\n    const rate = total > 0 ? ((rejected / total) * 100).toFixed(0) : 0;\n    document.getElementById('st-reject').textContent = rate + '%';\n  }\n\n  // Throughput ‚Äî articles per day (from first article to now)\n  if (articles && articles.length > 0 && totalPublished) {\n    const { data: oldest } = await api('/rest/v1/articles?select=published_at&order=published_at.asc&limit=1');\n    if (oldest && oldest.length > 0) {\n      const firstDate = new Date(oldest[0].published_at);\n      const days = Math.max(1, (Date.now() - firstDate.getTime()) / 86400000);\n      document.getElementById('st-throughput').textContent = (totalPublished / days).toFixed(1);\n    }\n  }\n}\n\n// ‚îÄ‚îÄ Main Refresh ‚îÄ‚îÄ\nasync function refresh() {\n  try {\n    const [articlesRes, draftsRes, logsRes, allDraftsRes] = await Promise.all([\n      api('/rest/v1/articles?select=*&order=published_at.desc&limit=20'),\n      api('/rest/v1/article_drafts?select=*&status=neq.published&order=created_at.desc&limit=30'),\n      api('/rest/v1/agent_log?select=*&order=created_at.desc&limit=50'),\n      api('/rest/v1/article_drafts?select=id,status&order=created_at.desc&limit=500'),\n    ]);\n\n    renderArticlesTable(articlesRes.data);\n    renderDraftsTable(draftsRes.data);\n    renderLogFeed(logsRes.data);\n    renderPipeline(allDraftsRes.data);\n    renderAgents(logsRes.data);\n    await renderStats(articlesRes.data, allDraftsRes.data);\n\n    document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });\n  } catch (err) {\n    console.error('Dashboard refresh error:', err);\n  }\n}\n\n// ‚îÄ‚îÄ Init ‚îÄ‚îÄ\nrefresh();\nsetInterval(refresh, REFRESH_MS);\n</script>\n</body>\n</html>\n";
module.exports = (req, res) => {
  res.setHeader('Content-Type', 'text/html');
  res.status(200).send(html);
};